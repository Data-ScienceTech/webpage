---
interface Props {
  content: {
    security_audit: {
      modal_title: string;
      modal_subtitle: string;
      form: {
        name_label: string;
        email_label: string;
        company_label: string;
        role_label: string;
        ai_systems_label: string;
        ai_systems_placeholder: string;
        concerns_label: string;
        concerns_placeholder: string;
        submit: string;
        success: string;
        error: string;
        close: string;
      };
    };
  };
  lang: string;
}

const { content, lang } = Astro.props;
const formName = lang === 'en' ? 'security-audit' : 'security-audit-fr';
---

<!-- Modal Backdrop -->
<div
  id="security-audit-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
>
  <!-- Modal Content -->
  <div class="relative w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-2xl bg-white dark:bg-secondary-800 shadow-2xl">
    <!-- Close Button -->
    <button
      type="button"
      id="close-modal-btn"
      class="absolute right-4 top-4 p-2 text-secondary-500 hover:text-secondary-700 dark:text-secondary-400 dark:hover:text-secondary-200 transition-colors"
      aria-label={content.security_audit.form.close}
    >
      <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Modal Header -->
    <div class="px-6 pt-6 pb-4 border-b border-secondary-200 dark:border-secondary-700">
      <div class="flex items-center gap-3 mb-2">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-100 dark:bg-primary-900/30">
          <svg class="h-5 w-5 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
          </svg>
        </div>
        <h2 id="modal-title" class="text-xl font-bold text-secondary-900 dark:text-white">
          {content.security_audit.modal_title}
        </h2>
      </div>
      <p class="text-secondary-600 dark:text-secondary-400">
        {content.security_audit.modal_subtitle}
      </p>
    </div>

    <!-- Form -->
    <form
      name={formName}
      method="POST"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      class="px-6 py-6 space-y-4"
      id="security-audit-form"
    >
      <input type="hidden" name="form-name" value={formName} />
      <input type="hidden" name="subject" value="[Security Audit Request] New inquiry from website" />
      <p class="hidden">
        <label>
          Don't fill this out: <input name="bot-field" />
        </label>
      </p>

      <!-- Name -->
      <div>
        <label for="audit-name" class="label">{content.security_audit.form.name_label}</label>
        <input
          type="text"
          id="audit-name"
          name="name"
          required
          class="input-field"
        />
      </div>

      <!-- Email -->
      <div>
        <label for="audit-email" class="label">{content.security_audit.form.email_label}</label>
        <input
          type="email"
          id="audit-email"
          name="email"
          required
          class="input-field"
        />
      </div>

      <!-- Company -->
      <div>
        <label for="audit-company" class="label">{content.security_audit.form.company_label}</label>
        <input
          type="text"
          id="audit-company"
          name="company"
          required
          class="input-field"
        />
      </div>

      <!-- Role -->
      <div>
        <label for="audit-role" class="label">{content.security_audit.form.role_label}</label>
        <input
          type="text"
          id="audit-role"
          name="role"
          class="input-field"
        />
      </div>

      <!-- AI Systems -->
      <div>
        <label for="audit-ai-systems" class="label">{content.security_audit.form.ai_systems_label}</label>
        <input
          type="text"
          id="audit-ai-systems"
          name="ai_systems"
          placeholder={content.security_audit.form.ai_systems_placeholder}
          class="input-field"
        />
      </div>

      <!-- Security Concerns -->
      <div>
        <label for="audit-concerns" class="label">{content.security_audit.form.concerns_label}</label>
        <textarea
          id="audit-concerns"
          name="security_concerns"
          rows="3"
          placeholder={content.security_audit.form.concerns_placeholder}
          class="input-field"
        ></textarea>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="btn-primary w-full flex items-center justify-center gap-2"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
        {content.security_audit.form.submit}
      </button>

      <!-- Success Message (hidden by default) -->
      <div id="form-success" class="hidden p-4 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-center">
        <svg class="h-6 w-6 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        {content.security_audit.form.success}
      </div>

      <!-- Error Message (hidden by default) -->
      <div id="form-error" class="hidden p-4 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-center">
        {content.security_audit.form.error}
      </div>
    </form>
  </div>
</div>

<script>
  // Modal functionality
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('security-audit-modal');
    const closeBtn = document.getElementById('close-modal-btn');
    const openBtns = document.querySelectorAll('[data-open-audit-modal]');
    const form = document.getElementById('security-audit-form') as HTMLFormElement;
    const successMsg = document.getElementById('form-success');
    const errorMsg = document.getElementById('form-error');

    function openModal() {
      modal?.classList.remove('hidden');
      modal?.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal?.classList.add('hidden');
      modal?.classList.remove('flex');
      document.body.style.overflow = '';
      // Reset form and messages
      form?.reset();
      successMsg?.classList.add('hidden');
      errorMsg?.classList.add('hidden');
    }

    // Open modal triggers
    openBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();
      });
    });

    // Close modal
    closeBtn?.addEventListener('click', closeModal);

    // Close on backdrop click
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Form submission with Netlify
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      
      try {
        const response = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData as any).toString()
        });

        if (response.ok) {
          successMsg?.classList.remove('hidden');
          form.reset();
          // Auto-close modal after 3 seconds
          setTimeout(() => {
            closeModal();
          }, 3000);
        } else {
          errorMsg?.classList.remove('hidden');
        }
      } catch (error) {
        errorMsg?.classList.remove('hidden');
      }
    });
  });
</script>
